<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>JemsPantry</title>

  <style>
    :root {
      --primary: #2D7A4F;
      --primary-dark: #1F5632;
      --primary-light: #E8F5E9;
      --surface: #FFFFFF;
      --bg: #F5F5F5;
      --text-primary: #1C1C1E;
      --text-secondary: #6B7280;
      --border: #E5E7EB;
      --danger: #EF4444;     /* âœ… solid red */
      --success: #10B981;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --storage-fridge: #FFFFFF;
      --storage-cupboard: #FFF3DB;
      --storage-freezer: #D4F7FF;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100vh;
      overflow: hidden;
    }

    /* ============ HEADER ============ */
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 16px 0;
      box-shadow: var(--shadow-md);
      padding-top: max(16px, env(safe-area-inset-top));
      padding-bottom: 12px;
    }

    .header-content { padding: 0 16px 0 16px; }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 14px;
    }

    /* ============ HEADER ACTIONS ============ */
    .header-actions {
      position: absolute;
      top: 12px;
      right: 16px;
      z-index: 1001;
      padding-top: max(0px, env(safe-area-inset-top));
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .cart-btn, .help-btn {
      position: relative;
      width: 44px;
      height: 44px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .help-btn {
      border-radius: 999px; /* small circle */
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.22);
      border: 1px solid rgba(255,255,255,0.18);
      font-weight: 1000;
      font-size: 18px;
      line-height: 1;
    }

    .cart-btn:active, .help-btn:active {
      transform: scale(0.9);
      background: rgba(255, 255, 255, 0.3);
    }

    .cart-icon { width: 22px; height: 22px; }

    .cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }
    .cart-badge.hidden { display: none; }

    /* ============ SEARCH BAR ============ */
    .search-container{
      position: relative;
      margin-bottom: 12px;
      padding-right: 86px; /* âœ… leaves room for help + cart */
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 0 12px;
      gap: 8px;
    }

    #search {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px 4px;
      font-size: 16px;
      outline: none;
      color: var(--text-primary);
      -webkit-appearance: none;
    }
    #search::placeholder { color: var(--text-secondary); }

    .search-clear {
      width: 28px;
      height: 28px;
      border: none;
      background: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: none;
      padding: 0;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .search-clear.active { display: flex; }

    .search-icon { width: 20px; height: 20px; flex-shrink: 0; color: var(--primary); }

    /* ============ FILTER CHIPS ============ */
    .filter-group { margin-bottom: 10px; }

    .filter-label {
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.85);
      display: block;
      margin-bottom: 6px;
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
    }
    .filter-chips::-webkit-scrollbar { display: none; }

    .chip {
      padding: 7px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      transition: all 0.2s ease;
      user-select: none;
    }
    .chip:active { transform: scale(0.95); }
    .chip.active { background: rgba(255, 255, 255, 0.95); color: var(--primary); border-color: rgba(255, 255, 255, 0.95); }

    /* ============ MAIN CONTENT ============ */
    .content-wrapper {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      padding-top: var(--header-height, 200px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: max(84px, env(safe-area-inset-bottom));
    }

    .container { padding: 12px; padding-bottom: 20px; max-width: 100%; }

    /* ============ EMPTY STATE ============ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h2 { margin: 0 0 8px; font-size: 16px; color: var(--text-primary); }
    .empty-state p { margin: 0; font-size: 14px; }

    /* ============ CATEGORY CARD ============ */
    .category-card {
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 10px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      animation: fadeIn 0.3s ease;
    }
    .category-card.open { box-shadow: var(--shadow-md); }

    .cat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 14px;
      background: linear-gradient(135deg, rgba(45, 122, 79, 0.06) 0%, rgba(45, 122, 79, 0.02) 100%);
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .category-card.open .cat-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .cat-title {
      margin: 0;
      font-size: 15px;
      font-weight: 800;
      color: var(--primary);
      flex: 1;
    }
    .category-card.open .cat-title { color: white; }

    .cat-count {
      font-size: 12px;
      font-weight: 900;
      color: white;
      background: var(--primary);
      padding: 4px 10px;
      border-radius: 12px;
      min-width: 32px;
      text-align: center;
    }
    .category-card.open .cat-count { background: rgba(255, 255, 255, 0.3); }

    .cat-toggle-icon {
      width: 20px;
      height: 20px;
      margin-left: 8px;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    .category-card.open .cat-toggle-icon { transform: rotate(180deg); }

    .cat-content {
      display: none;
      padding: 8px 8px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .category-card.open .cat-content { display: block; max-height: 10000px; }

    /* ============ ITEM ROW ============ */
    .item-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 8px;
      gap:10px;
      border-radius:8px;
      transition:background 0.15s ease;
      margin-bottom:10px;
    }
    .cat-content .item-row:last-of-type { margin-bottom: 0; }

    .item-row.fridge { background: var(--storage-fridge); border: 1px solid #E5E7EB; }
    .item-row.cupboard { background: var(--storage-cupboard); }
    .item-row.freezer { background: var(--storage-freezer); }

    .item-row.out-of-stock { opacity: 0.55; }
    .item-row.out-of-stock .item-label { text-decoration: line-through; }

    .item-info { flex: 1; min-width: 0; }

    .item-label{
      display:block;
      font-size:16px;
      font-weight:900;
      color:var(--text-primary);
      margin-bottom:2px;
      word-break:break-word;
      line-height:1.15;
    }

    .item-meta{
      font-size:10px;
      color:var(--text-secondary);
      text-transform:uppercase;
      font-weight:700;
      letter-spacing:0.3px;
      line-height: 1.2;
    }

    .item-cat{
      margin-top: 2px;
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    .item-submeta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      line-height: 1.25;
      word-break: break-word;
    }

    .item-actions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      flex-shrink:0;
      width: 132px;
    }

    .item-controls { display:flex; flex-direction:column; gap:8px; width:100%; }

    .add-to-shop{
      display:none;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 10px;
      background: var(--primary-light);
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
      color:var(--primary);
      transition:all 0.2s ease;
      width:100%;
    }
    .add-to-shop.show { display:flex; }
    .add-to-shop.in-cart { background: var(--success); color: white; }
    .add-to-shop:active { transform: scale(0.95); }
    .add-to-shop-icon { width: 14px; height: 14px; }

    .qty-control {
      display: flex;
      align-items: center;
      background: var(--bg);
      border-radius: 10px;
      padding: 2px;
      gap: 3px;
      box-shadow: var(--shadow-sm);
      width: 100%;
      justify-content: space-between;
    }

    .qty-btn {
      width: 34px;
      height: 34px;
      border: none;
      background: white;
      border-radius: 8px;
      color: white;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }
    .qty-btn.plus { background: #3B82F6; }
    .qty-btn.minus { background: var(--danger); }
    .qty-btn:active { transform: scale(0.88); }

    .qty-display {
      width: 44px;
      text-align: center;
      font-weight: 900;
      font-size: 14px;
      color: var(--text-primary);
    }

    .item-footer-actions{
      display:flex;
      gap:8px;
      width:100%;
    }

    .edit-btn {
      width: 44px;
      height: 36px;
      border: none;
      border-radius: 10px;
      background: rgba(45, 122, 79, 0.12);
      color: var(--primary);
      font-weight: 900;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .edit-btn:active { transform: scale(0.92); }

    /* âœ… solid red remove button */
    .delete-btn {
      display:none;
      flex:1;
      height: 36px;
      border: none;
      border-radius: 10px;
      padding: 0 10px;
      background: var(--danger);
      color: white;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .delete-btn:active { transform: scale(0.96); opacity: 0.95; }

    .item-row.out-of-stock .item-footer-actions .delete-btn{
      display:block;
    }

    /* ============ MODALS ============ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1500;
      display: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .modal-overlay.active { display: flex; opacity: 1; }

    .modal-content {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 1501;
      animation: slideUpModal 0.22s ease;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 16px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1502;
    }

    .modal-header h2 { margin: 0; font-size: 18px; font-weight: 900; }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .modal-close:active { transform: scale(0.9); }
    .modal-body { padding: 16px; }

    /* ============ SHOPPING LIST ============ */
    .shopping-list-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .shopping-list-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .shopping-list-grouped { margin-bottom: 20px; }

    .shopping-store-header {
      font-size: 13px;
      font-weight: 900;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .shopping-list-item {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .shopping-item-checkbox {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--primary);
      flex-shrink: 0;
    }
    .shopping-item-info { flex: 1; min-width: 0; }
    .shopping-item-name {
      display: block;
      font-size: 14px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .shopping-item-remove {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--danger);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .shopping-item-remove:active { transform: scale(0.9); }

    .shopping-list-item.checked { opacity: 0.6; background: rgba(16, 185, 129, 0.1); }
    .shopping-list-item.checked .shopping-item-name { text-decoration: line-through; color: var(--text-secondary); }

    .shopping-actions {
      display: flex;
      gap: 8px;
      padding: 16px;
      background: var(--bg);
      border-radius: 10px;
      margin-top: 16px;
    }

    .btn-action {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .btn-action.primary { background: var(--primary-light); color: var(--primary); }
    .btn-action.primary:active { transform: scale(0.95); background: var(--primary); color: white; }
    .btn-action.danger { background: var(--danger); color: white; }
    .btn-action.danger:active { transform: scale(0.95); opacity: 0.9; }

    .shopping-list-count {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      padding: 12px 0;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }

    /* ============ ADD/EDIT ITEM MODAL FORM ============ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    .field label { font-size: 12px; font-weight: 900; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.4px; }
    .field input, .field select, .field textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
      background: white;
      color: var(--text-primary);
    }
    .field textarea { min-height: 76px; resize: vertical; }

    .form-actions { display: flex; gap: 10px; margin-top: 8px; }

    .btn-wide {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 12px 12px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-size: 13px;
    }
    .btn-wide.primary { background: var(--primary); color: white; }
    .btn-wide.primary:active { transform: scale(0.97); background: var(--primary-dark); }
    .btn-wide.secondary { background: rgba(107,114,128,0.15); color: var(--text-primary); }
    .btn-wide.secondary:active { transform: scale(0.97); opacity: 0.9; }
    .btn-wide.danger { background: var(--danger); color: white; }
    .btn-wide.danger:active { transform: scale(0.97); opacity: 0.9; }

    /* ============ FAB (ADD BUTTON) ============ */
    .fab {
      position: fixed;
      right: 16px;
      bottom: max(16px, env(safe-area-inset-bottom));
      z-index: 1200;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #34D399 0%, #2D7A4F 100%);
      color: white;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 900;
      transition: transform 0.15s ease;
    }
    .fab:active { transform: scale(0.92); }

    /* ============ CONFIRM MODAL ============ */
    .confirm-sheet {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      box-shadow: var(--shadow-lg);
      padding: 16px;
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      animation: slideUpModal 0.22s ease;
    }

    .confirm-title {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 900;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .confirm-message {
      margin: 0 0 14px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      line-height: 1.35;
    }

    .confirm-actions { display: flex; gap: 10px; }

    .confirm-btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 12px 12px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.12s ease, opacity 0.12s ease;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .confirm-btn:active { transform: scale(0.97); }
    .confirm-btn.yes { background: var(--success); color: white; }
    .confirm-btn.no  { background: var(--danger); color: white; }

    /* ============ TOAST ============ */
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      z-index: 2000;
      display: none;
      box-shadow: var(--shadow-lg);
      animation: slideUpToast 0.3s ease;
      max-width: calc(100% - 40px);
      text-align: center;
    }

    /* ============ SPLASH + GUIDE ============ */
    .splash-overlay{
      position: fixed;
      inset: 0;
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: radial-gradient(1200px 700px at 50% 30%, #2D7A4F 0%, #0F3D25 55%, #072416 100%);
    }
    .splash-overlay.active{ display: flex; }

    .splash-card{
      width: min(520px, 100%);
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      color: #fff;
      text-align: center;
    }

    .splash-logo{
      width: min(340px, 82%);
      height: auto;
      display: block;
      margin: 10px auto 10px;
      border-radius: 18px;
    }

    .splash-title{
      margin: 6px 0 2px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.3px;
    }

    .splash-version{
      margin: 0 0 12px;
      font-size: 12px;
      font-weight: 900;
      opacity: 0.85;
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }

    .splash-actions{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .splash-btn{
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor: pointer;
      font-size: 14px;
      letter-spacing: 0.3px;
    }

    .splash-btn.primary{ background: #10B981; color: #fff; }
    .splash-btn.secondary{
      background: rgba(255,255,255,0.18);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .splash-note{
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.85;
      line-height: 1.35;
    }

    .splash-skip{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.9;
    }
    .splash-skip input{
      width: 18px;
      height: 18px;
      accent-color: #10B981;
    }

    .guide h3{
      margin: 12px 0 6px;
      font-size: 14px;
      font-weight: 900;
      color: var(--text-primary);
    }
    .guide p, .guide li{
      margin: 0 0 8px;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-secondary);
    }
    .guide ul{ margin: 0 0 10px 18px; padding: 0; }
    .guide .tip{
      background: rgba(45, 122, 79, 0.08);
      border: 1px solid rgba(45, 122, 79, 0.18);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 800;
    }

    /* ============ ANIMATIONS ============ */
    @keyframes slideUpToast {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes slideUpModal {
      from { transform: translateY(24px); opacity: 0.9; }
      to   { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .cat-title { font-size: 14px; }
      .item-label { font-size: 15px; }
      .form-grid { grid-template-columns: 1fr; }
      .item-actions{ width: 124px; }
      .search-container{ padding-right: 86px; }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --surface: #1E293B;
        --bg: #0F172A;
        --text-primary: #F1F5F9;
        --text-secondary: #94A3B8;
        --border: #334155;
        --primary-light: rgba(45, 122, 79, 0.2);
      }
      .search-input-wrapper { background: rgba(30, 41, 59, 0.8); }
      #search { color: var(--text-primary); }
      .chip { border-color: rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); }
      .cat-header { background: rgba(45, 122, 79, 0.08); }
      .qty-control { background: #334155; }
      .item-row.fridge { border-color: rgba(255,255,255,0.18); }
      .field input, .field select, .field textarea { background: rgba(15, 23, 42, 0.5); color: var(--text-primary); }
    }
  </style>
</head>

<body>
  <!-- SPLASH OVERLAY -->
  <div class="splash-overlay" id="splash">
    <div class="splash-card">
      <!-- Put JP_logo.png in the same folder as index.html -->
      <img src="JP_logo.png" class="splash-logo" alt="JemsPantry logo">
      <div class="splash-title">JemsPantry</div>
      <div class="splash-version" id="splashVersion">Version</div>

      <div class="splash-actions">
        <button class="splash-btn primary" onclick="startApp()">Start</button>
        <button class="splash-btn secondary" onclick="openUserGuide()">User Guide</button>
      </div>

      <label class="splash-skip">
        <input type="checkbox" id="skipSplash">
        Donâ€™t show this again
      </label>

      <div class="splash-note">
        Local-only: your items are saved on this device.
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-actions">
      <!-- âœ… Help icon -->
      <button class="help-btn" onclick="openUserGuide()" aria-label="Help">?</button>

      <button class="cart-btn" onclick="openShoppingList()" aria-label="Shopping list">
        <svg class="cart-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0020 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
        <span class="cart-badge hidden" id="cartBadge">0</span>
      </button>
    </div>

    <div class="header-content">
      <h1>JemsPantry</h1>

      <div class="search-container">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="search" placeholder="Search items...">
          <button class="search-clear" onclick="clearSearch()">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Location</span>
        <div class="filter-chips">
          <div class="chip" onclick="setFilter('loc','Kitchen',this)">Kitchen</div>
          <div class="chip" onclick="setFilter('loc','Garage',this)">Garage</div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Storage Type</span>
        <div class="filter-chips">
          <div class="chip" onclick="setFilter('stor','Fridge',this)">Fridge</div>
          <div class="chip" onclick="setFilter('stor','Cupboard',this)">Cupboard</div>
          <div class="chip" onclick="setFilter('stor','Freezer',this)">Freezer</div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Region</span>
        <div class="filter-chips" id="regionChips">
          <div class="chip" onclick="setRegion('UK', this)">UK</div>
          <div class="chip" onclick="setRegion('US', this)">US</div>
          <div class="chip" onclick="setRegion('EU', this)">EU</div>
          <div class="chip" onclick="setRegion('Global', this)">Global</div>
        </div>
      </div>
    </div>
  </div>

  <div class="content-wrapper" id="contentWrapper">
    <div class="container" id="main"></div>
    <div id="toast"></div>
  </div>

  <button class="fab" onclick="openItemEditor(null)" aria-label="Add item">+</button>

  <!-- SHOPPING LIST MODAL -->
  <div class="modal-overlay" id="shoppingModal" onclick="closeShoppingList(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Shopping List</h2>
        <button class="modal-close" onclick="closeShoppingList()">âœ•</button>
      </div>
      <div class="modal-body" id="shoppingListContent">
        <div class="shopping-list-empty">
          <div class="shopping-list-empty-icon">ðŸ›’</div>
          <h3 style="margin: 0 0 8px; font-size: 16px; color: var(--text-primary);">No items yet</h3>
          <p>Add items from your pantry to start shopping</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD / EDIT ITEM MODAL -->
  <div class="modal-overlay" id="itemModal" onclick="closeItemEditor(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="itemModalTitle">Add Item</h2>
        <button class="modal-close" onclick="closeItemEditor()">âœ•</button>
      </div>
      <div class="modal-body" id="itemModalBody">
        <div class="field">
          <label>Item Name</label>
          <input id="f_item" type="text" placeholder="e.g. Milk, Chicken Breast" autocomplete="off">
        </div>

        <div class="form-grid">
          <div class="field">
            <label>Store</label>
            <input id="f_store" type="text" placeholder="e.g. Tesco, Iceland" autocomplete="off">
          </div>

          <div class="field">
            <label>Quantity</label>
            <input id="f_qty" type="number" min="0" step="1" value="1">
          </div>

          <div class="field">
            <label>Location</label>
            <select id="f_location">
              <option value="Kitchen">Kitchen</option>
              <option value="Garage">Garage</option>
            </select>
          </div>

          <div class="field">
            <label>Storage Type</label>
            <select id="f_storage">
              <option value="Fridge">Fridge</option>
              <option value="Cupboard">Cupboard</option>
              <option value="Freezer">Freezer</option>
            </select>
          </div>

          <div class="field">
            <label>Category</label>
            <select id="f_category">
              <option value="">Auto (recommended)</option>
            </select>
          </div>

          <div class="field">
            <label>Expiry Date</label>
            <input id="f_expiry" type="date">
          </div>
        </div>

        <div class="field">
          <label>Notes</label>
          <textarea id="f_notes" placeholder="Optional notes..."></textarea>
        </div>

        <div class="form-actions">
          <button class="btn-wide secondary" onclick="closeItemEditor()">Cancel</button>
          <button class="btn-wide primary" onclick="saveItemFromModal()">Save</button>
        </div>

        <div class="form-actions" id="deleteRow" style="display:none;">
          <button class="btn-wide danger" onclick="deleteItemFromModal()">Delete Item</button>
        </div>
      </div>
    </div>
  </div>

  <!-- USER GUIDE MODAL -->
  <div class="modal-overlay" id="guideModal" onclick="closeUserGuide(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>How to use JemsPantry</h2>
        <button class="modal-close" onclick="closeUserGuide()">âœ•</button>
      </div>
      <div class="modal-body guide">
        <div class="tip">Quick start: Tap <b>+</b> to add your first item.</div>

        <h3>Add items</h3>
        <ul>
          <li>Tap the green <b>+</b> button.</li>
          <li>Enter <b>Item Name</b> first, then store, quantity, location, storage, category, expiry and notes.</li>
          <li>Tap <b>Save</b>.</li>
        </ul>

        <h3>Edit items</h3>
        <ul>
          <li>Tap the <b>âœŽ</b> pencil on a card.</li>
          <li>Update fields and tap <b>Save</b>.</li>
        </ul>

        <h3>Quantity</h3>
        <ul>
          <li>Use <b>âˆ’</b> and <b>+</b> on the item card.</li>
          <li>When an item reaches <b>0</b>, the <b>Remove</b> button appears.</li>
        </ul>

        <h3>Shopping list</h3>
        <ul>
          <li>When stock is low, an <b>Add</b> button appears on the card.</li>
          <li>Tap the cart icon to view the shopping list.</li>
          <li>Tick items as you buy them, or remove them.</li>
        </ul>

        <h3>Search & filters</h3>
        <ul>
          <li>Use the search bar to find items instantly.</li>
          <li>Use chips to filter by <b>Location</b> and <b>Storage Type</b>.</li>
          <li>Region helps smart category detection recognise brands.</li>
        </ul>

        <div class="tip">Tip: Your data is stored locally on this device (no account required).</div>
      </div>
    </div>
  </div>

  <!-- CLEAN CONFIRM MODAL -->
  <div class="modal-overlay" id="confirmModal" onclick="closeConfirm(event)">
    <div class="confirm-sheet" onclick="event.stopPropagation()">
      <h3 class="confirm-title" id="confirmTitle">Confirm</h3>
      <p class="confirm-message" id="confirmMessage">Are you sure?</p>
      <div class="confirm-actions">
        <button class="confirm-btn no" id="confirmNoBtn" onclick="confirmNo()">No</button>
        <button class="confirm-btn yes" id="confirmYesBtn" onclick="confirmYes()">Yes</button>
      </div>
    </div>
  </div>

<script>
  // ===== Version =====
  const APP_VERSION = "1.0.0";

  // ===== State =====
  let inventory = [];
  let shoppingList = [];
  let filters = { loc: new Set(), stor: new Set() };
  let openCats = new Set();

  const INVENTORY_STORAGE_KEY = "jemspantry_inventory_v1";
  const SHOPPING_STORAGE_KEY  = "jemspantry_shoppingList_v1";
  const OPENCATS_STORAGE_KEY  = "jemspantry_openCats_v1";
  const REGION_KEY            = "jemspantry_region_v1";
  const STORE_COLORS_KEY      = "jemspantry_storeColors_v1";
  const SPLASH_SKIP_KEY       = "jemspantry_skipSplash_v1";

  let region = "UK";
  let storeColors = {};
  let editingId = null;

  const CATEGORIES = [
    "Fruit & Veg",
    "Meat, Poultry & Seafood",
    "Dairy & Refrigerated",
    "Bakery & Bread",
    "Pantry & Dry Goods",
    "Canned Goods & Sauces",
    "Frozen Foods",
    "Snacks",
    "Beverages",
    "Condiments & Oils",
    "Household & Cleaning",
    "Personal Care & Pharmacy"
  ];

  // Brand packs used to gently improve auto-category by region
  const REGION_BRANDS = {
    UK: {
      dairy: ["cathedral city","arla","muller","mÃ¼ller","oatly","alpro","lurpak","kerrygold","anchor","philadelphia"],
      bakery: ["warburtons","kingsmill","hovis","allinsons","allinson's","jacksons","jackson's","roberts","sunblest"],
      canned: ["heinz","branston","baxters","princes","john west","napolina","mutti","cirio"],
      snacks: ["walkers","mcvities","cadbury","tunnocks","foxs","fox's","tyrrells","kettle","pringles","doritos"],
      beverages: ["coca cola","coca-cola","pepsi","ribena","lucozade","vimto","tango","robinsons","irn bru","irn-bru"]
    },
    US: {
      dairy: ["kraft","philadelphia","land o'lakes","daisy","chobani","yoplait","dannon","horizon","silk","oatly"],
      bakery: ["wonder","pepperidge farm","sara lee","nature's own","entennmann's","martin's","bimbo","oroweat","ball park","thomas'"],
      canned: ["campbell's","progresso","hunts","del monte","libby's","hormel","stagg","goya","bush's","heinz"],
      snacks: ["lays","doritos","cheetos","ritz","oreo","hershey's","reese's","kellogg's","quaker","nature valley"],
      beverages: ["gatorade","powerade","coke","coca-cola","pepsi","dr pepper","mountain dew","snapple","arizona"]
    },
    EU: {
      dairy: ["danone","nestle","muller","mÃ¼ller","arla","president","prÃ©sident","galbani","valio","kerrygold"],
      bakery: ["barilla","mulino bianco","wasa","jacquet","bonduelle"],
      canned: ["mutti","cirio","bonduelle","rio mare","ortiz","knorr","heinz"],
      snacks: ["haribo","milka","ritter sport","lays","pringles","kinder","ferrero","nutella","oreo","jacobs"],
      beverages: ["coca-cola","pepsi","fanta","sprite","san pellegrino","lavazza","nescafe","nespresso"]
    },
    Global: {
      dairy: ["danone","nestle","oatly","alpro","arla","philadelphia","yoplait","muller","mÃ¼ller","kerrygold"],
      bakery: ["bimbo","barilla","warburtons","hovis","pepperidge farm","sara lee","wasa"],
      canned: ["heinz","campbell's","mutti","cirio","del monte","libby's","princes","john west","goya","knorr"],
      snacks: ["pringles","oreo","doritos","lays","kettle","walkers","haribo","kinder","cadbury","mcvities"],
      beverages: ["coca-cola","pepsi","fanta","sprite","nescafe","nespresso","lavazza"]
    }
  };

  // ==================== CLEAN CONFIRM MODAL ====================
  let _confirm = { onYes: null, onNo: null };

  function showConfirm({ title, message, yesText = "Yes", noText = "No", onYes, onNo }) {
    _confirm.onYes = typeof onYes === "function" ? onYes : null;
    _confirm.onNo  = typeof onNo  === "function" ? onNo  : null;
    document.getElementById("confirmTitle").textContent = title || "Confirm";
    document.getElementById("confirmMessage").textContent = message || "Are you sure?";
    document.getElementById("confirmYesBtn").textContent = yesText;
    document.getElementById("confirmNoBtn").textContent  = noText;
    document.getElementById("confirmModal").classList.add("active");
  }
  function closeConfirm(event) {
    if (event && event.target !== document.getElementById("confirmModal")) return;
    document.getElementById("confirmModal").classList.remove("active");
    _confirm.onYes = null;
    _confirm.onNo = null;
  }
  function confirmYes() { const fn = _confirm.onYes; closeConfirm(); if (fn) fn(); }
  function confirmNo()  { const fn = _confirm.onNo;  closeConfirm(); if (fn) fn(); }

  // ==================== SPLASH + GUIDE ====================
  function showSplashIfNeeded(){
    document.getElementById("splashVersion").textContent = `Version ${APP_VERSION}`;
    const skip = localStorage.getItem(SPLASH_SKIP_KEY) === "1";
    if (!skip) document.getElementById("splash").classList.add("active");
  }

  function startApp(){
    const dontShow = document.getElementById("skipSplash")?.checked;
    if (dontShow) localStorage.setItem(SPLASH_SKIP_KEY, "1");
    document.getElementById("splash").classList.remove("active");
  }

  function openUserGuide(){
    document.getElementById("guideModal").classList.add("active");
  }
  function closeUserGuide(event){
    if (event && event.target !== document.getElementById("guideModal")) return;
    document.getElementById("guideModal").classList.remove("active");
  }

  // ==================== NORMALISE ====================
  function normalizeText(s) {
    return String(s || "")
      .toLowerCase()
      .replace(/[â€™']/g, "'")
      .replace(/&/g, " and ")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ==================== STORE COLORS ====================
  function storeKey(store) { return normalizeText(store); }

  function loadStoreColors() {
    try {
      const raw = localStorage.getItem(STORE_COLORS_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      storeColors = (parsed && typeof parsed === "object") ? parsed : {};
    } catch (e) {
      storeColors = {};
    }
    if (!storeColors[storeKey("Tesco")]) storeColors[storeKey("Tesco")] = "#3B82F6";
    if (!storeColors[storeKey("Iceland")]) storeColors[storeKey("Iceland")] = "#EF4444";
    saveStoreColors();
  }
  function saveStoreColors() { try { localStorage.setItem(STORE_COLORS_KEY, JSON.stringify(storeColors)); } catch (e) {} }
  function getStoreColor(store) { const key = storeKey(store); return key ? (storeColors[key] || null) : null; }
  function setStoreColor(store, hex) { const key = storeKey(store); if (!key) return; storeColors[key] = hex; saveStoreColors(); }

  function getContrastingTextColor(hexColor) {
    const hex = String(hexColor || "").replace("#", "");
    if (hex.length !== 6) return "#FFFFFF";
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.62 ? "#000000" : "#FFFFFF";
  }

  function ensureStoreHasColor(store) {
    const s = String(store || "").trim();
    if (!s) return;
    if (getStoreColor(s)) return;

    const defaults = ["#2D7A4F", "#3B82F6", "#EF4444", "#F59E0B", "#8B5CF6", "#06B6D4", "#EC4899"];
    const key = storeKey(s);
    let hash = 0;
    for (let i = 0; i < key.length; i++) hash = (hash * 31 + key.charCodeAt(i)) >>> 0;
    const suggested = defaults[hash % defaults.length];

    const picker = document.createElement("input");
    picker.type = "color";
    picker.value = suggested;
    picker.style.position = "fixed";
    picker.style.left = "-9999px";
    document.body.appendChild(picker);

    picker.addEventListener("input", () => {
      setStoreColor(s, picker.value);
      toast(`Colour saved for ${s}`);
      renderShoppingList();
    }, { once: true });

    picker.addEventListener("change", () => picker.remove(), { once: true });
    picker.click();
  }

  // ==================== LOCAL STORAGE ====================
  function saveInventoryToStorage() { try { localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventory)); } catch (e) {} }
  function loadInventoryFromStorage() {
    try {
      const raw = localStorage.getItem(INVENTORY_STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) { return []; }
  }

  function saveOpenCatsToStorage() { try { localStorage.setItem(OPENCATS_STORAGE_KEY, JSON.stringify([...openCats])); } catch (e) {} }
  function loadOpenCatsFromStorage() {
    try {
      const raw = localStorage.getItem(OPENCATS_STORAGE_KEY);
      if (!raw) return new Set();
      const parsed = JSON.parse(raw);
      return new Set(Array.isArray(parsed) ? parsed : []);
    } catch (e) { return new Set(); }
  }

  function saveShoppingList() { try { localStorage.setItem(SHOPPING_STORAGE_KEY, JSON.stringify(shoppingList)); } catch (e) {} }
  function loadShoppingListFromStorage() {
    try {
      const raw = localStorage.getItem(SHOPPING_STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) { return []; }
  }

  function reconcileShoppingListWithInventory() {
    const byRow = new Map(inventory.map(i => [i.rowNumber, i]));
    shoppingList = shoppingList
      .filter(x => byRow.has(x.rowNumber))
      .map(x => {
        const inv = byRow.get(x.rowNumber);
        return { ...x, item: inv.item, store: inv.store, quantity: inv.quantity, category: inv.category };
      });
    saveShoppingList();
  }

  // ==================== REGION ====================
  function loadRegion() { try { region = localStorage.getItem(REGION_KEY) || "UK"; } catch (e) { region = "UK"; } }
  function saveRegion() { try { localStorage.setItem(REGION_KEY, region); } catch (e) {} }

  function syncRegionChipsUI() {
    const wrap = document.getElementById("regionChips");
    if (!wrap) return;
    [...wrap.querySelectorAll(".chip")].forEach(ch => {
      const val = ch.textContent.trim();
      ch.classList.toggle("active", val === region);
    });
  }

  function setRegion(val, el) {
    region = val;
    saveRegion();
    const row = el.parentElement;
    [...row.querySelectorAll(".chip")].forEach(c => c.classList.remove("active"));
    el.classList.add("active");
    toast(`Region: ${val}`);
    render();
  }

  // ==================== SMART AUTO CATEGORY DETECTION ====================
  function detectCategoryAuto(item) {
    const name = normalizeText(item.item);
    if (item.storage === "Freezer") return "Frozen Foods";

    const scores = new Map();
    const add = (cat, pts) => scores.set(cat, (scores.get(cat) || 0) + pts);
    const has = (k) => name.includes(normalizeText(k));

    const BRAND = {
      produce: ["dole", "fyffes", "pink lady", "chiquita"],
      bakery: ["warburtons", "kingsmill", "hovis", "allinson's", "allinsons", "jackson's", "jacksons", "roberts"],
      dairy: ["cathedral city", "arla", "lactofree", "lacto free", "yazoo", "actimel", "danone", "yoplait", "muller", "mÃ¼ller", "oatly", "alpro", "flora", "clover", "lurpak", "kerrygold", "anchor", "philadelphia"],
      meat: ["heck", "richmond", "bernard matthews"],
      fish: ["young's", "youngs", "birds eye", "birdseye", "princes", "john west", "mowi"],
      dry: ["uncle ben's", "uncle bens", "ben's original", "bens original", "dolmio", "barilla", "napolina", "sharwood's", "sharwoods", "patak's", "pataks", "bachelor's", "bachelors", "super noodles", "pot noodle", "blue dragon", "schwartz", "colman's", "colmans"],
      canned: ["heinz", "branston", "princes", "napolina", "mutti", "cirio", "john west"],
      condiments: ["heinz", "hp", "hellmann's", "hellmanns", "colman's", "colmans", "tabasco", "kikkoman", "encona"],
      cleaning: ["fairy", "persil", "bold", "ariel", "lenor", "comfort", "flash", "cif", "domestos", "dettol", "andrex", "cushelle"],
      meds: ["calpol", "nurofen", "benylin", "strepsils", "lemsip", "gaviscon", "panadol", "sudafed"]
    };

    if (BRAND.produce.some(has)) add("Fruit & Veg", 6);
    if (BRAND.bakery.some(has)) add("Bakery & Bread", 7);
    if (BRAND.dairy.some(has)) add("Dairy & Refrigerated", 8);
    if (BRAND.meat.some(has)) add("Meat, Poultry & Seafood", 6);
    if (BRAND.fish.some(has)) add("Meat, Poultry & Seafood", 7);
    if (BRAND.dry.some(has)) add("Pantry & Dry Goods", 5);
    if (BRAND.canned.some(has)) add("Canned Goods & Sauces", 6);
    if (BRAND.condiments.some(has)) add("Condiments & Oils", 6);
    if (BRAND.cleaning.some(has)) add("Household & Cleaning", 8);
    if (BRAND.meds.some(has)) add("Personal Care & Pharmacy", 10);

    const pack = REGION_BRANDS[region] || REGION_BRANDS.Global;
    if (pack?.dairy?.some(has))     add("Dairy & Refrigerated", 3);
    if (pack?.bakery?.some(has))    add("Bakery & Bread", 3);
    if (pack?.canned?.some(has))    add("Canned Goods & Sauces", 3);
    if (pack?.snacks?.some(has))    add("Snacks", 2);
    if (pack?.beverages?.some(has)) add("Beverages", 2);

    // Keyword rules
    if ([
      "vegetable","vegetables","veg","carrot","broccoli","cabbage","lettuce","spinach","kale","cucumber",
      "tomato","tomatoes","pepper","onion","garlic","leek","potato","potatoes","sweet potato",
      "courgette","zucchini","aubergine","eggplant","mushroom","asparagus","green beans","peas",
      "blueberry","strawberry","raspberry","blackberry","apple","orange","banana","grape","melon","watermelon",
      "pineapple","mango","lime","lemon","avocado","kiwi"
    ].some(has)) add("Fruit & Veg", 10);

    if ([
      "milk","yoghurt","yogurt","cheese","cheddar","mozzarella","parmesan","feta","brie",
      "cream cheese","butter","eggs","cream","sour cream","cottage cheese","lactose free"
    ].some(has)) add("Dairy & Refrigerated", 10);

    if ([
      "beef","pork","lamb","chicken","turkey","duck","steak","mince","ground beef","ground chicken",
      "sausage","sausages","bacon","burger","burgers","fish","salmon","tuna","cod","haddock",
      "prawns","shrimp","seafood"
    ].some(has)) add("Meat, Poultry & Seafood", 10);

    if ([
      "bread","roll","rolls","bagel","bagels","wrap","wraps","naan","pitta","pita","baguette","sourdough","croissant"
    ].some(has)) add("Bakery & Bread", 10);

    if ([
      "rice","pasta","noodles","ramen","couscous","quinoa","lentil","lentils","flour","oats","porridge",
      "herb","spice","seasoning","paprika","cumin","turmeric","cinnamon","salt","pepper"
    ].some(has)) add("Pantry & Dry Goods", 10);

    if ([
      "tin","tins","tinned","canned","passata","chopped tomatoes","baked beans","chickpeas","kidney beans",
      "jar","jars","pesto","pickle","olives","capers","pasta sauce","curry sauce"
    ].some(has)) add("Canned Goods & Sauces", 10);

    if ([
      "oil","olive oil","vegetable oil","ketchup","mayo","mayonnaise","mustard","vinegar","bbq","hot sauce",
      "soy sauce","tamari","teriyaki","dressing"
    ].some(has)) add("Condiments & Oils", 10);

    if ([
      "frozen","ice cream","pizza","frozen pizza","chips","fries","hash browns","nuggets","dumplings","gyoza","spring rolls"
    ].some(has)) add("Frozen Foods", 10);

    if ([
      "biscuit","biscuits","cookie","cookies","chocolate","crisps","chips","popcorn","nuts","snack"
    ].some(has)) add("Snacks", 10);

    if ([
      "juice","drink","cola","coke","pepsi","fanta","sprite","lemonade","squash","cordial","smoothie",
      "tea","coffee","hot chocolate"
    ].some(has)) add("Beverages", 10);

    if ([
      "cleaning","detergent","washing powder","laundry","bleach","disinfectant","wipes",
      "toilet paper","tissues","bin bags","foil","cling film","washing up liquid"
    ].some(has)) add("Household & Cleaning", 10);

    if ([
      "medicine","vitamins","paracetamol","ibuprofen","cold","flu","cough","antacid","allergy",
      "shampoo","conditioner","soap","toothpaste","deodorant","sunscreen","lotion","moisturiser","moisturizer"
    ].some(has)) add("Personal Care & Pharmacy", 12);

    let best = null, bestScore = 0;
    for (const [cat, score] of scores.entries()) {
      if (score > bestScore) { bestScore = score; best = cat; }
    }
    return best;
  }

  function getCategory(item) {
    if (item.category && String(item.category).trim()) return String(item.category).trim();
    return detectCategoryAuto(item);
  }

  // ==================== UTILITIES ====================
  function updateHeaderHeight() {
    const header = document.querySelector('.header');
    const height = header.offsetHeight;
    document.documentElement.style.setProperty('--header-height', height + 'px');
  }

  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2500);
  }

  function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(text ?? '').replace(/[&<>"']/g, m => map[m]);
  }

  function clearSearch() {
    document.getElementById('search').value = '';
    document.querySelector('.search-clear').classList.remove('active');
    render();
  }

  function setFilter(type, val, el) {
    filters[type].has(val) ? filters[type].delete(val) : filters[type].add(val);
    el.classList.toggle('active');
    render();
  }

  function toggleCategory(cat) {
    openCats.has(cat) ? openCats.delete(cat) : openCats.add(cat);
    saveOpenCatsToStorage();
    render();
  }

  // ==================== SHOPPING LIST ====================
  function addToShoppingList(rowNumber) {
    const item = inventory.find(x => x.rowNumber === rowNumber);
    if (!item) return;

    const existingItem = shoppingList.find(x => x.rowNumber === rowNumber);

    if (existingItem) {
      shoppingList = shoppingList.filter(x => x.rowNumber !== rowNumber);
      toast('Removed from shopping list');
    } else {
      shoppingList.push({
        rowNumber: rowNumber,
        item: item.item,
        store: item.store,
        quantity: item.quantity,
        category: item.category,
        checked: false
      });
      toast('Added to shopping list');
    }

    saveShoppingList();
    updateCartBadge();
    render();
    renderShoppingList();
  }

  function updateCartBadge() {
    const badge = document.getElementById('cartBadge');
    const count = shoppingList.length;
    if (count === 0) badge.classList.add('hidden');
    else { badge.classList.remove('hidden'); badge.textContent = count; }
  }

  function openShoppingList() {
    document.getElementById('shoppingModal').classList.add('active');
    renderShoppingList();
  }

  function closeShoppingList(event) {
    if (event && event.target !== document.getElementById('shoppingModal')) return;
    document.getElementById('shoppingModal').classList.remove('active');
  }

  function toggleShoppingItem(index) {
    if (shoppingList[index]) {
      shoppingList[index].checked = !shoppingList[index].checked;
      saveShoppingList();
      renderShoppingList();
    }
  }

  function removeFromShoppingList(index) {
    shoppingList.splice(index, 1);
    saveShoppingList();
    updateCartBadge();
    render();
    renderShoppingList();
  }

  function clearCheckedItems() {
    shoppingList = shoppingList.filter(x => !x.checked);
    saveShoppingList();
    updateCartBadge();
    render();
    renderShoppingList();
  }

  function clearAllItems() {
    showConfirm({
      title: "Clear shopping list?",
      message: "This will remove all items from your shopping list.",
      yesText: "Yes",
      noText: "No",
      onYes: () => {
        shoppingList = [];
        saveShoppingList();
        updateCartBadge();
        render();
        renderShoppingList();
        toast("Shopping list cleared");
      }
    });
  }

  function renderShoppingList() {
    const content = document.getElementById('shoppingListContent');

    if (shoppingList.length === 0) {
      content.innerHTML = `
        <div class="shopping-list-empty">
          <div class="shopping-list-empty-icon">ðŸ›’</div>
          <h3 style="margin: 0 0 8px; font-size: 16px; color: var(--text-primary);">No items yet</h3>
          <p>Add items from your pantry to start shopping</p>
        </div>
      `;
      return;
    }

    const grouped = {};
    shoppingList.forEach((item, index) => {
      const store = item.store || 'Other';
      if (!grouped[store]) grouped[store] = [];
      grouped[store].push({ ...item, index });
    });

    let html = '';

    Object.keys(grouped).sort().forEach(store => {
      const bg = getStoreColor(store) || "#2D7A4F";
      const fg = getContrastingTextColor(bg);

      html += `<div class="shopping-list-grouped">`;
      html += `<div class="shopping-store-header" style="background:${bg};color:${fg};">${escapeHtml(store)}</div>`;

      grouped[store].forEach(item => {
        html += `
          <div class="shopping-list-item ${item.checked ? 'checked' : ''}">
            <input type="checkbox" class="shopping-item-checkbox"
                   ${item.checked ? 'checked' : ''}
                   onchange="toggleShoppingItem(${item.index})">
            <div class="shopping-item-info">
              <span class="shopping-item-name">${escapeHtml(item.item)}</span>
            </div>
            <button class="shopping-item-remove" onclick="removeFromShoppingList(${item.index})">âœ•</button>
          </div>
        `;
      });

      html += `</div>`;
    });

    html += `
      <div class="shopping-actions">
        <button class="btn-action primary" onclick="clearCheckedItems()">Clear Checked</button>
        <button class="btn-action danger" onclick="clearAllItems()">Clear All</button>
      </div>
      <div class="shopping-list-count">
        ${shoppingList.filter(x => x.checked).length} of ${shoppingList.length} items
      </div>
    `;

    content.innerHTML = html;
  }

  // ==================== ADD / EDIT ITEM MODAL ====================
  function populateCategoryDropdown() {
    const sel = document.getElementById('f_category');
    let html = `<option value="">Auto (recommended)</option>`;
    CATEGORIES.forEach(c => html += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`);
    sel.innerHTML = html;
  }

  function scrollItemModalToTop() {
    const body = document.getElementById("itemModalBody");
    if (body) body.scrollTop = 0;
  }

  function openItemEditor(rowNumber) {
    populateCategoryDropdown();
    const modal = document.getElementById('itemModal');
    const title = document.getElementById('itemModalTitle');
    const delRow = document.getElementById('deleteRow');

    editingId = rowNumber;

    // âœ… always scroll to top so Item Name is visible first
    scrollItemModalToTop();

    if (!rowNumber) {
      title.textContent = "Add Item";
      delRow.style.display = "none";

      document.getElementById('f_item').value = "";
      document.getElementById('f_store').value = "";
      document.getElementById('f_qty').value = 1;
      document.getElementById('f_location').value = "Kitchen";
      document.getElementById('f_storage').value = "Cupboard";
      document.getElementById('f_category').value = "";
      document.getElementById('f_expiry').value = "";
      document.getElementById('f_notes').value = "";

      modal.classList.add('active');

      // âœ… focus item name
      setTimeout(() => {
        scrollItemModalToTop();
        document.getElementById('f_item').focus();
      }, 60);

      return;
    }

    const item = inventory.find(x => x.rowNumber === rowNumber);
    if (!item) return;

    title.textContent = "Edit Item";
    delRow.style.display = "block";

    document.getElementById('f_item').value = item.item || "";
    document.getElementById('f_store').value = item.store || "";
    document.getElementById('f_qty').value = Number.isFinite(item.quantity) ? item.quantity : 1;
    document.getElementById('f_location').value = item.location || "Kitchen";
    document.getElementById('f_storage').value = item.storage || "Cupboard";
    document.getElementById('f_category').value = item.category || "";
    document.getElementById('f_expiry').value = item.expiry || "";
    document.getElementById('f_notes').value = item.notes || "";

    modal.classList.add('active');
    setTimeout(() => scrollItemModalToTop(), 60);
  }

  function closeItemEditor(event) {
    if (event && event.target !== document.getElementById('itemModal')) return;
    document.getElementById('itemModal').classList.remove('active');
    editingId = null;
  }

  function saveItemFromModal() {
    const itemName = document.getElementById('f_item').value.trim();
    if (!itemName) { toast("Item name required"); return; }

    const payload = {
      item: itemName,
      store: document.getElementById('f_store').value.trim(),
      quantity: Math.max(0, parseInt(document.getElementById('f_qty').value || "0", 10)),
      location: document.getElementById('f_location').value,
      storage: document.getElementById('f_storage').value,
      category: document.getElementById('f_category').value,
      expiry: document.getElementById('f_expiry').value,
      notes: document.getElementById('f_notes').value.trim()
    };

    ensureStoreHasColor(payload.store);

    if (!editingId) {
      const newId = Date.now() + Math.floor(Math.random() * 1000);
      inventory.push({ rowNumber: newId, ...payload });
      toast("Item added");
    } else {
      const idx = inventory.findIndex(x => x.rowNumber === editingId);
      if (idx !== -1) inventory[idx] = { ...inventory[idx], ...payload };
      toast("Item updated");
    }

    saveInventoryToStorage();
    reconcileShoppingListWithInventory();
    updateCartBadge();
    render();
    closeItemEditor();
  }

  function deleteItemFromModal() {
    if (!editingId) return;
    const item = inventory.find(x => x.rowNumber === editingId);
    if (!item) return;

    showConfirm({
      title: "Delete item?",
      message: `Delete "${item.item}" from this device?`,
      yesText: "Yes",
      noText: "No",
      onYes: () => {
        inventory = inventory.filter(x => x.rowNumber !== editingId);
        shoppingList = shoppingList.filter(x => x.rowNumber !== editingId);
        saveInventoryToStorage();
        saveShoppingList();
        updateCartBadge();
        render();
        closeItemEditor();
        toast("Item deleted");
      }
    });
  }

  // ==================== DELETE ITEM (CARD) ====================
  function deleteItem(row) {
    const item = inventory.find(x => x.rowNumber === row);
    if (!item) return;

    showConfirm({
      title: "Delete item?",
      message: `Delete "${item.item}" from this device?`,
      yesText: "Yes",
      noText: "No",
      onYes: () => {
        inventory = inventory.filter(x => x.rowNumber !== row);
        shoppingList = shoppingList.filter(x => x.rowNumber !== row);
        saveInventoryToStorage();
        saveShoppingList();
        render();
        updateCartBadge();
        toast("Item deleted");
      }
    });
  }

  // ==================== UPDATE QTY ====================
  function updateQty(row, delta) {
    const item = inventory.find(x => x.rowNumber === row);
    if (!item) return;

    item.quantity = Math.max(0, (item.quantity ?? 0) + delta);

    const inCart = shoppingList.find(x => x.rowNumber === row);
    if (inCart) { inCart.quantity = item.quantity; saveShoppingList(); }

    saveInventoryToStorage();
    render();
  }

  // ==================== RENDER ====================
  function render() {
    const container = document.getElementById('main');
    const query = document.getElementById('search').value.toLowerCase();
    const searchBtn = document.querySelector('.search-clear');

    searchBtn.classList.toggle('active', query.length > 0);
    container.innerHTML = '';

    const filtered = inventory.filter(i => {
      const name = (i.item || "").toLowerCase();
      const store = (i.store || "").toLowerCase();
      const notes = (i.notes || "").toLowerCase();
      const sMatch = !query || name.includes(query) || store.includes(query) || notes.includes(query);
      const lMatch = filters.loc.size === 0 || filters.loc.has(i.location);
      const rMatch = filters.stor.size === 0 || filters.stor.has(i.storage);
      return sMatch && lMatch && rMatch;
    });

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ðŸ“­</div>
          <h2>No items found</h2>
          <p>Try adjusting your filters or search</p>
        </div>
      `;
      return;
    }

    const allCats = [...new Set([...CATEGORIES, ...filtered.map(i => getCategory(i) || 'Uncategorised')])];

    allCats.forEach(cat => {
      const items = filtered.filter(i => (getCategory(i) || 'Uncategorised') === cat);
      if (items.length === 0) return;

      const block = document.createElement('div');
      block.className = `category-card ${openCats.has(cat) ? 'open' : ''}`;

      const catHeader = document.createElement('div');
      catHeader.className = 'cat-header';
      catHeader.onclick = () => toggleCategory(cat);
      catHeader.innerHTML = `
        <h2 class="cat-title">${escapeHtml(cat)}</h2>
        <span class="cat-count">${items.length}</span>
        <svg class="cat-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      `;
      block.appendChild(catHeader);

      const content = document.createElement('div');
      content.className = 'cat-content';

      items.sort((a, b) => (b.quantity || 0) - (a.quantity || 0)).forEach(i => {
        const isInCart = shoppingList.some(x => x.rowNumber === i.rowNumber);
        const showAddBtn = (i.quantity ?? 0) <= 2;

        const row = document.createElement('div');
        const storageClass = i.storage === "Fridge" ? "fridge" : i.storage === "Cupboard" ? "cupboard" : "freezer";
        row.className = `item-row ${storageClass} ${(i.quantity ?? 0) === 0 ? 'out-of-stock' : ''}`;

        const expiryLine = i.expiry ? `Expiry: ${escapeHtml(i.expiry)}` : "";
        const notesLine = i.notes ? `Notes: ${escapeHtml(i.notes)}` : "";

        row.innerHTML = `
          <div class="item-info">
            <span class="item-label">${escapeHtml(i.item)}</span>
            <div class="item-meta">${escapeHtml(i.store || "Store")} â€¢ ${escapeHtml(i.location)} â€¢ ${escapeHtml(i.storage)}</div>
            <div class="item-cat">${escapeHtml(getCategory(i) || "Uncategorised")}</div>
            ${(expiryLine || notesLine) ? `<div class="item-submeta">${[expiryLine, notesLine].filter(Boolean).join(" â€¢ ")}</div>` : ""}
          </div>

          <div class="item-actions">
            <div class="item-controls">
              <button class="add-to-shop ${showAddBtn ? 'show' : ''} ${isInCart ? 'in-cart' : ''}" onclick="addToShoppingList(${i.rowNumber})">
                <svg class="add-to-shop-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0020 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                ${isInCart ? 'In Cart' : 'Add'}
              </button>

              <div class="qty-control">
                <button class="qty-btn minus" onclick="updateQty(${i.rowNumber}, -1)">âˆ’</button>
                <div class="qty-display">${i.quantity ?? 0}</div>
                <button class="qty-btn plus" onclick="updateQty(${i.rowNumber}, 1)">+</button>
              </div>

              <div class="item-footer-actions">
                <button class="edit-btn" onclick="openItemEditor(${i.rowNumber})" title="Edit">âœŽ</button>
                <button class="delete-btn" onclick="deleteItem(${i.rowNumber})">Remove</button>
              </div>
            </div>
          </div>
        `;

        content.appendChild(row);
      });

      block.appendChild(content);
      container.appendChild(block);
    });
  }

  // ==================== LOAD ====================
  function load() {
    openCats = loadOpenCatsFromStorage();
    inventory = loadInventoryFromStorage();
    shoppingList = loadShoppingListFromStorage();

    loadRegion();
    syncRegionChipsUI();
    loadStoreColors();

    if (!inventory || inventory.length === 0) {
      inventory = [
        { rowNumber: 1, item: "Bananas", category: "Fruit & Veg", store: "Tesco", location: "Kitchen", storage: "Cupboard", quantity: 5, expiry: "", notes: "" },
        { rowNumber: 2, item: "Milk", category: "Dairy & Refrigerated", store: "Tesco", location: "Kitchen", storage: "Fridge", quantity: 1, expiry: "", notes: "" },
        { rowNumber: 3, item: "Chicken Breast", category: "Meat, Poultry & Seafood", store: "Iceland", location: "Kitchen", storage: "Freezer", quantity: 3, expiry: "", notes: "" }
      ];
      saveInventoryToStorage();
    }

    inventory.forEach(i => ensureStoreHasColor(i.store));

    reconcileShoppingListWithInventory();
    updateCartBadge();
    render();
    updateHeaderHeight();
  }

  // ==================== INIT ====================
  window.addEventListener('load', () => {
    load();
    updateHeaderHeight();
    showSplashIfNeeded();
  });

  window.addEventListener('resize', updateHeaderHeight);

  document.getElementById('search').addEventListener('input', () => render());

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeShoppingList();
      closeItemEditor();
      closeConfirm();
      closeUserGuide();
      // don't force-close splash on ESC (nice UX)
    }
  });

  document.getElementById("f_store").addEventListener("blur", (e) => {
    const s = e.target.value.trim();
    if (s) ensureStoreHasColor(s);
  });
</script>
</body>
</html>
